# Toilet Tails â€” Build Log & Runbook
_Last updated: 2025-08-23_

## Stack (current)
- Next.js (App Router) + TypeScript + Tailwind
- Supabase Storage (private `uploads` bucket) via server SDK + **signed URLs**
- Prisma + SQLite (dev) â€” will swap to Supabase Postgres in prod
- Inngest queue for async render jobs
- AI pipeline: fal.ai (FLUX Pro Kontext image-to-image) primary, Replicate SD img2img fallback; REMBG disabled
- Hosting: Vercel (planned)

## Key paths
- `src/app/api/storage/sign/route.ts` â€” mints signed upload URL (key + token)
- `src/app/api/upload/commit/route.ts` â€” commits metadata to DB; returns signed previews
- `src/app/api/render/route.ts` â€” POST create job, passes user options, enqueues Inngest event
- `src/app/api/render/[uploadId]/route.ts` â€” GET latest job (for polling)
- `src/app/api/upload/route.ts` â€” legacy server-upload (kept for reference)
- `src/components/HomeClient.tsx` â€” scene â†’ (optional) bathroom â†’ pet upload (direct-to-Supabase) â†’ Generate + polling
- `src/components/UploadBox.tsx`, `src/components/ScenePicker.tsx`
- `src/lib/supabaseServer.ts` (server-only), `src/lib/supabaseClient.ts` (browser)
- `src/lib/storage.ts` â€” storage adapter (now uses Supabase)
- `prisma/schema.prisma` â€” `Upload`, `RenderJob`
- `src/lib/functions/renderJob.ts` â€” Inngest function driver
- `src/lib/functions/aiPipeline.ts` â€” compose via fal.ai/flux-pro/kontext, save to Supabase
- `src/lib/fal.ts` â€” fal.ai client config (`@fal-ai/client`)
- `src/lib/replicateHttp.ts` â€” non-streaming Replicate Predictions helper

## Env vars (web/.env)
- DATABASE_URL="file:./prisma/dev.db"
- SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, SUPABASE_BUCKET="uploads"
- NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY
- REPLICATE_API_TOKEN
- FAL_KEY
- REMBG_API_KEY (currently unused)

## API contracts
**POST `/api/storage/sign`** â†’ `{ bucket, key, token }` for one-time direct upload.  
**POST `/api/upload/commit`** body: `{ pet:{key,name,type,size}, bg?:{...}, scene }` â†’ creates `Upload`, returns signed URLs + `uploadId`.  
**POST `/api/render`** body: `{ uploadId, options?: { identityStrength?: number, aspectRatio?: string, upscale?: boolean } }` â†’ enqueues job.  
**GET  `/api/render/:uploadId`** â†’ latest job for polling.

## Prisma models (dev)
Upload(id, key, url, name, type, size, scene?, bgKey?, bgUrl?, createdAt)
RenderJob(id, uploadId, status, resultUrl?, error?, aiSteps?, finalKey?, createdAt, updatedAt)

## Current user flow
1) Choose scene (required)
2) (Optional) upload bathroom background (direct to Supabase)
3) Adjust controls: identity strength, aspect ratio, upscale
4) Upload pet (direct to Supabase)
5) Commit metadata â†’ get `uploadId`
6) Click Generate â†’ job created; UI polls status â†’ shows result

## Dev commands
cd web
npm run dev
npm run lint
npx prisma migrate dev
npx prisma studio

## Decisions & Next
- âœ… Direct-to-Supabase uploads; server only commits metadata
- âœ… Inngest queue + fal.ai Kontext img2img primary, Replicate fallback
- âœ… Identity/AR controls
- ðŸ”œ Optional background compositing + inpaint
- ðŸ”œ Swap to Supabase Postgres in Vercel
- ðŸ”œ Auth + rate limits; Stripe checkout
- ðŸ”œ Moderation, admin views, observability
